#!/bin/bash

set -u -e

# env context

ns=${ns:=demo\:ndeploy}
rediscli=${rediscli:=redis-cli -n 13}

# logging

debug() {
  >&2 echo "DEBUG $serviceKey - $*"
}

info() {
  >&2 echo "INFO $serviceKey - $*"
}

warn() {
  >&2 echo "WARN $serviceKey - $*"
}


# lifecycle

abort() {
  echo "WARN abort: $*"
  exit 1
}


# utils

grepq() {
  [ $# -eq 1 ]
  grep -q "^${1}$"
}

grepe() {
  [ $# -eq 1 ]
  expect="$1"
  if ! cat | grep -q "$expect"
  then
    echo "WARN $expect"
    return 0
  else
    return 1
  fi
}

# redis utils

redis() {
  $rediscli $*
}

redise() {
  expect=$1
  shift
  rcmd="$@"
  if echo "$rcmd" | grep -qv " $ns:"
  then
    >&2 echo "WARN $rcmd"
    return 1
  fi
  reply=`$rediscli $rcmd`
  if ! echo "$reply" | grep -q "^${expect}$"
  then
    >&2 echo "WARN $rcmd - reply $reply - not $expect"
    return 2
  else
    return 0
  fi
}

redis0() {
  [ $# -gt 1 ]
  redise 0 $*
}

redis1() {
  [ $# -gt 1 ]
  redise 1 $*
}

expire() {
  info "expire $*"
  [ $# -eq 2 ]
  redis1 expire $*
}

exists() {
  [ $# -eq 1 ]
  redis1 exists $1
}

nexists() {
  [ $# -eq 1 ]
  redis0 exists $1
}

hgetall() {
  [ $# -eq 1 ]
  key=$1
  echo "$key" | grep -q "^$ns:\w[:a-z0-9]*$"
  >&2 echo "DEBUG hgetall $key"
  >&2 $rediscli hgetall $key
}

incr() {
  [ $# -eq 1 ]
  key=$1
  echo "$key" | grep -q "^$ns:\w[:a-z0-9]*$"
  seq=`$rediscli incr $key`
  echo "$seq" | grep '^[1-9][0-9]*$'
}

hsetnx() {
  [ $# -eq 3 ]
  $rediscli hsetnx $* | grep -q '^1$'
}

lpush() {
  [ $# -eq 2 ]
  reply=`$rediscli lpush $*`
  debug "lpush $* - $reply"
  echo "$reply" | grep -q '^[1-9][0-9]*$'
}

brpoplpush() {
  [ $# -eq 3 ]
  popId=`$rediscli brpoplpush $*`
  debug "brpoplpush $* - $popId"
  echo $popId | grep '^[1-9][0-9]*$'
}

brpop() {
  [ $# -eq 2 ]
  debug "$rediscli brpop $*"
  popId=`$rediscli brpop $* | tail -1`
  debug "brpop $* - $popId"
  echo $popId | grep '^[1-9][0-9]*$'
}

lrem() {
  [ $# -eq 3 ]
  $rediscli lrem $* | grep -q '^[1-9][0-9]*$'
}

llen() {
  [ $# -eq 1 ]
  llen=`$rediscli llen $*`
  debug "llen $* - $llen"
  echo $llen | grep '^[1-9][0-9]*$'
}

hincrbyq() {
  [ $# -eq 3 ]
  reply=`$rediscli hincrby $*`
  debug "hincrby $* - $reply"
  echo $reply | grep -q '^[1-9][0-9]*$'
}

hgetd() {
  [ $# -eq 3 ]
  defaultValue=$1
  key=$2
  field=$3
  value=`$rediscli hget $key $field`
  if [ -z "$value" ]
  then
    echo "$defaultValue"
  else
    echo $value
  fi
}

incrid() {
  [ $# -eq 1 ]
  name=$1
  id=`incr $ns:$name:id`
  redis0 exists $ns:$name:$id
  echo $id
}

# init service, to expire after 120 seconds

serviceId=`incrid service | tail -1`
serviceKey="$ns:service:$serviceId"
hincrbyq $ns:service:metric:started count 1
serviceDir=$HOME/.ndeploy/`echo $ns | tr ':' '-'`
info $serviceDir
redis0 exists $serviceKey
hsetnx $serviceKey host `hostname -s`
hsetnx $serviceKey pid $$
hsetnx $serviceKey started `$rediscli time | head -1`
expire $serviceKey 120
hgetall $serviceKey
mkdir -p $serviceDir && cd $serviceDir || exit 1
info pwd `pwd` $serviceDir

v1popError() {
  id=$1
  echo "ERROR pop: $*"
  $rediscli lpush $ns:req $id
  $rediscli lrem $ns:req:pending -1 $id
  exit 9
}

pendingId=''

c0exit() {
  if [ -n "$pendingId" ]
  then
    v1popError $pendingId
  fi
}

trap c0exit exit

c1popped() {
  id=$1
  git=`$rediscli hget $ns:req:$id git | grep '^http\|^git@'`
  branch=`hgetd master $ns:req:$id branch`
  commit=`$rediscli hget $ns:req:$id commit`
  tag=`$rediscli hget $ns:req:$id tag`
  cd $serviceDir
  ls -lht
  deployDir="$serviceDir/$id"
  [ ! -d $deployDir ]
  hsetnx $ns:res:$id deployDir $deployDir
  expire $ns:res:$id 900 # ttl sufficient for git clone and npm install
  echo "INFO deployDir $deployDir"
  mkdir -p $deployDir && cd $deployDir
  git clone $git -b $branch $branch
  cd $branch
  if [ -n "$commit" ]
  then
    echo "INFO git checkout $commit -- $git $branch"
    git checkout $commit
  elif [ -n "$tag" ]
  then
    echo "INFO git checkout tags/$tag -- $git $tag"
    git checkout tags/$tag
  fi
  hsetnx $ns:res:$id cloned `stat -c %Z $deployDir`
  if [ -f package.json ]
  then
    cat package.json
    npm --silent install
    hsetnx $ns:res:$id npmInstalled `stat -c %Z node_modules`
  fi
  actualCommit=`git log | head -1 | cut -d' ' -f2`
  echo "INFO actualCommit $actualCommit"
  hsetnx $ns:res:$id actualCommit $actualCommit
  deployDir=`$rediscli hget $ns:res:$id deployDir`
  debug "OK popped $id $deployDir"
  echo $deployDir | grep '/'
}

c1pop() {
  popTimeout=$1
  expire $serviceKey $popTimeout
  rcmd="brpoplpush $ns:req $ns:pending $popTimeout"
  id=`$rediscli $rcmd | grep '^[1-9][0-9]*$'`
  debug "popped $id"
  [ -n $id ]
  pendingId=$id
  expire $ns:req:$id 10
  hgetall $ns:req:$id
  c1popped $id
  redis1 sadd $ns:res:ids $id
  redis1 persist $ns:res:$id
  hgetall $ns:res:$id
  lpush $ns:res $id
  pendingId=''
}


# test

c1req() {
  gitUrl="$1"
  id=`incr $ns:req:id`
  hsetnx $ns:req:$id git $gitUrl
  lpush $ns:req $id
  debug "OK $id $gitUrl"
  echo $id
}

c3req() {
  debug c3req $@
  [ $# -eq 3 ]
  gitUrl="$1"
  branch="$2"
  commit="$3"
  id=`incr $ns:req:id`
  hsetnx $ns:req:$id git $gitUrl
  [ -n "$branch" -a "$branch" != 'master' ] && hsetnx $ns:req:$id branch $branch
  [ -n "$commit" -a "$commit" != 'HEAD' ] && hsetnx $ns:req:$id commit $commit
  #[ -n "$tag" ] && hsetnx $ns:req:$id tag $tag
  lpush $ns:req $id
  debug "OK $id $gitUrl"
  echo $id
}

c2brpop() {
  reqId=$1
  popTimeout=$2
  resId=`brpop $ns:res $popTimeout | tail -1`
  if [ "$reqId" != "$resId" ]
  then
    warn "mismatched ids: $reqId, $resId: lpush $ns:res $resId"
    lpush $ns:res $resId
    return 1
  fi
  $rediscli hget $ns:res:$id deployDir | grep '/'
}

c2deploy() {
  popTimeout=$1
  gitUrl=$2
  id=`c1req $gitUrl | tail -1`
  c2brpop $id $popTimeout
}

c4deploy() {
  [ $# -eq 4 ]
  resTimeout=$1
  shift
  id=`c3req $@ | tail -1`
  c2brpop $id $resTimeout
}

c0tdeploy() {
  set -e
  c4deploy 60 https://github.com/evanx/hello-component master HEAD
}

c0tclear13() {
  rm -rf $HOME/.ndeploy/demo-ndeploy
  redis-cli -n 13 keys "$ns:*" | xargs -n1 redis-cli -n 13 del
}

c0test() {
  c0tpush & c1pop 10
}


# command

info "rediscli $rediscli"
info "args $@"

command=test
if [ $# -ge 1 ]
then
  command=$1
  shift
  c$#$command $@
fi
